const { createClient } = require('@supabase/supabase-js');
const { Pool } = require('pg');

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_KEY;
const serviceKey = process.env.SUPABASE_SERVICE_KEY;

const supabase = createClient(supabaseUrl, supabaseKey);
const supabaseAdmin = createClient(supabaseUrl, serviceKey);

const pool = new Pool({
  connectionString: process.env.DB_CONNECTION_STRING,
  ssl: { rejectUnauthorized: false },
  idleTimeoutMillis: 10000,
  query_timeout: 10000
});

const promisePool = pool;

const initDatabase = async () => {
  try {
    await pool.query(`
      CREATE TABLE IF NOT EXISTS users (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        role VARCHAR(50) DEFAULT 'admin',
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      )
    `);

    await pool.query(`
      CREATE TABLE IF NOT EXISTS leads (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        business_name VARCHAR(255) NOT NULL,
        phone VARCHAR(50) NOT NULL,
        category VARCHAR(50) DEFAULT 'Other',
        city VARCHAR(255),
        notes TEXT,
        status VARCHAR(20) DEFAULT 'pending',
        price DECIMAL(10,2),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      )
    `);

    const { data: users } = await supabaseAdmin
      .from('users')
      .select('*')
      .eq('email', process.env.ADMIN_EMAIL);

    if (!users || users.length === 0) {
      const bcrypt = require('bcryptjs');
      const hashedPassword = await bcrypt.hash(process.env.ADMIN_PASSWORD, 10);
      
      const { error } = await supabaseAdmin
        .from('users')
        .insert([
          { name: 'Admin', email: process.env.ADMIN_EMAIL, password: hashedPassword, role: 'admin' }
        ]);

      if (error) throw error;
      console.log(`Default admin user created: ${process.env.ADMIN_EMAIL} / ${process.env.ADMIN_PASSWORD}`);
    }

    console.log('Database initialized successfully');
  } catch (error) {
    console.error('Database initialization error:', error);
  }
};

module.exports = { supabase, supabaseAdmin, pool, promisePool, initDatabase };
